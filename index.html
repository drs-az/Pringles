<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#ffcc66" />
  <title>Pringle 1, 2, 3</title>
  <style>
    :root{
      --bg:#0b0b0c; --panel:#151518; --ink:#fafafa; --muted:#bdbdbd; --accent:#ffcc66; --accent-2:#ffd991;
      --chip-shadow: drop-shadow(0 14px 22px rgba(0,0,0,.55)) drop-shadow(0 2px 4px rgba(0,0,0,.35));
      --ok:#7bffb5;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:radial-gradient(1200px 1200px at 50% -200px,#1b1b1f 0,#0b0b0c 65%); color:var(--ink);
      font:500 16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      display:flex; align-items:center; justify-content:center; padding:22px;
    }
    .app{
      width:min(820px,100%); background:var(--panel); border:1px solid #22232a; border-radius:22px; padding:20px 18px 16px;
      box-shadow: 0 30px 80px rgba(0,0,0,.45); position:relative; overflow:hidden;
    }
    header{display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:8px}
    h1{margin:0; font-size:22px; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .chip-wrap{display:grid; place-items:center; padding:10px 0 2px}
    .chip-btn{
      appearance:none; background:none; border:0; cursor:pointer; padding:0; transition:transform .08s ease-out;
      touch-action:manipulation; -webkit-tap-highlight-color: transparent; position:relative;
    }
    .chip{width:min(78vw,420px); filter:var(--chip-shadow); display:block; will-change:transform}
    .pop{animation:pop .14s ease-out}
    @keyframes pop{0%{transform:scale(1)}70%{transform:scale(0.94) rotate(-1deg)}100%{transform:scale(1)}}
    .stats{margin:6px 2px 10px; display:grid; gap:8px}
    .card{
      background:#0e0f12; border:1px solid #23242c; border-radius:16px; padding:12px 14px;
      display:grid; gap:8px;
    }
    .row{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .row strong{font-size:22px}
    .metric{display:grid; gap:6px}
    .label{display:flex; align-items:center; justify-content:space-between}
    .label span:last-child{font-variant-numeric: tabular-nums}
    progress{
      width:100%; height:10px; border:0; border-radius:999px; background:#1c1d23; overflow:hidden;
    }
    progress::-webkit-progress-bar{background:#1c1d23}
    progress::-webkit-progress-value{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    progress::-moz-progress-bar{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .controls{display:flex; gap:10px; margin-top:10px; flex-wrap:wrap; align-items:center}
    button.ctrl{
      background:#1a1b21; color:#fff; border:1px solid #2c2d36; padding:10px 14px; border-radius:12px; cursor:pointer;
      font-weight:600; letter-spacing:.2px
    }
    button.ctrl:hover{border-color:#3a3b46}
    button.primary{background:var(--accent); color:#161616; border-color:#f2c35e}
    footer{margin-top:10px; color:#9a9aa0; font-size:13px; text-align:center}
    .tiny{font-size:12px;color:#a7a7a7}
    .toast{
      position:fixed; left:50%; bottom:24px; transform:translateX(-50%);
      background:#121317; border:1px solid #2b2c34; color:#e7ffe7; padding:10px 14px; border-radius:12px; 
      box-shadow:0 12px 30px rgba(0,0,0,.4); display:none; z-index:10;
    }
    .toast.show{display:block; animation:fade .3s ease-out}
    @keyframes fade{from{opacity:0; transform:translate(-50%,8px)} to{opacity:1; transform:translate(-50%,0)}}
    .badge{color:var(--ok); font-weight:700}

    /* Confetti canvas sits on top, ignores pointer events */
    #fxCanvas{
      position:absolute; inset:0; pointer-events:none;
    }
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <h1>Pringle 1, 2, 3</h1>
      <div class="muted tiny">Tap the chip to add one</div>
    </header>

    <div class="chip-wrap">
      <button id="chipBtn" class="chip-btn" aria-label="Add one Pringle" title="Tap to add one">
        <img src="pringle.png" class="chip" alt="Pringle chip" />
      </button>
    </div>

    <section class="stats">
      <div class="card" id="card">
        <div class="row">
          <div>Pringles eaten</div>
          <strong id="count">0</strong>
        </div>

        <div class="metric">
          <div class="label">
            <div>Calories <span class="tiny">(10.7 each)</span></div>
            <span><strong id="calories">0.0</strong> kcal • <span id="calPct">0.00%</span></span>
          </div>
          <progress id="calProg" max="100" value="0"></progress>
        </div>

        <div class="metric">
          <div class="label">
            <div>Sodium <span class="tiny">(12.9 mg each)</span></div>
            <span><strong id="sodium">0.0</strong> mg • <span id="sodPct">0.00%</span></span>
          </div>
          <progress id="sodProg" max="100" value="0"></progress>
        </div>
      </div>

      <div class="controls">
        <button id="undoBtn" class="ctrl" type="button">−1</button>
        <button id="resetBtn" class="ctrl" type="button">Reset</button>
        <button id="shareBtn" class="ctrl" type="button">Share</button>
        <button id="installBtn" class="ctrl primary" type="button" hidden>Install App</button>
        <span class="tiny muted" id="savedMsg" aria-live="polite"></span>
        <span id="a2hsHint" class="tiny" style="display:none">Tip: install requires HTTPS/localhost + valid icons.</span>
      </div>
    </section>

    <footer>
      Works offline. Progress is saved automatically.
    </footer>

    <div class="toast" id="toast"></div>

    <!-- Confetti canvas -->
    <canvas id="fxCanvas"></canvas>
  </div>

  <script>
    // --- Nutrition constants (per Pringle) ---
    const CAL_PER = 10.7;   // kcal
    const CAL_PCT = 0.54;   // % DV per chip
    const SOD_MG  = 12.9;   // mg
    const SOD_PCT = 0.57;   // % DV per chip

    // Achievements (threshold: name)
    const BADGES = [
      [20, 'First Stack'],
      [42, 'Life, the Universe & Pringles'],
      [63, 'Party Bowl'],
      [84, 'Tube Conqueror'],
      [100,'Century Crunch']
    ];

    // --- State helpers ---
    const $ = s => document.querySelector(s);
    const els = {
      app:     $('#app'),
      count:   $('#count'),
      calories:$('#calories'),
      calPct:  $('#calPct'),
      sodium:  $('#sodium'),
      sodPct:  $('#sodPct'),
      calProg: $('#calProg'),
      sodProg: $('#sodProg'),
      savedMsg:$('#savedMsg'),
      installBtn: $('#installBtn'),
      a2hsHint: $('#a2hsHint'),
      toast: $('#toast'),
      chipImg: document.querySelector('.chip'),
      fx: $('#fxCanvas'),
    };

    // persistent state
    let count = Number(localStorage.getItem('p123_count') || 0);
    let lastDate = localStorage.getItem('p123_date') || todayKey();
    let unlocked = new Set(JSON.parse(localStorage.getItem('p123_badges') || '[]'));

    function todayKey(){
      const d = new Date();
      return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    }

    // Daily reset if date changed (also schedule next midnight tick)
    function ensureToday(){
      const tk = todayKey();
      if (tk !== lastDate){
        count = 0;
        lastDate = tk;
        save();
      }
      scheduleMidnightReset();
    }
    function scheduleMidnightReset(){
      const now = new Date();
      const midnight = new Date(now);
      midnight.setHours(24,0,0,0);
      const ms = midnight - now;
      clearTimeout(window._midnightTimer);
      window._midnightTimer = setTimeout(()=>{ count = 0; lastDate = todayKey(); save(); update(); toast('New day — counter reset.'); scheduleMidnightReset(); }, ms);
    }

    function fmt(n, d=1){ return Number(n).toFixed(d); }
    function update(){
      els.count.textContent = count;
      const cals   = count * CAL_PER;
      const calPct = count * CAL_PCT;
      const sod    = count * SOD_MG;
      const sodPct = count * SOD_PCT;
      els.calories.textContent = fmt(cals, 1);
      els.calPct.textContent   = fmt(calPct, 2) + '%';
      els.sodium.textContent   = fmt(sod, 1);
      els.sodPct.textContent   = fmt(sodPct, 2) + '%';
      els.calProg.value = Math.min(100, calPct);
      els.sodProg.value = Math.min(100, sodPct);
    }
    function save(){
      localStorage.setItem('p123_count', String(count));
      localStorage.setItem('p123_date', lastDate);
      localStorage.setItem('p123_badges', JSON.stringify([...unlocked]));
      els.savedMsg.textContent = 'Saved';
      setTimeout(()=>els.savedMsg.textContent='', 900);
    }
    function toast(msg){ els.toast.innerHTML = msg; els.toast.classList.add('show'); setTimeout(()=>els.toast.classList.remove('show'), 2000); }

    function checkBadges(prev, now){
      for(const [n, name] of BADGES){
        if(now >= n && prev < n && !unlocked.has(n)){
          unlocked.add(n);
          toast(`🏅 <span class="badge">${name}</span> unlocked (${n})`);
        }
      }
    }

    // --- Crunch sound via Web Audio API (layered snap) ---
    let AC = null;
    function ensureAudio() {
      if (!AC) {
        const Ctx = window.AudioContext || window.webkitAudioContext;
        if (!Ctx) return;
        AC = new Ctx();
      }
    }
    function playCrunch() {
      if (!AC) return;
      const now = AC.currentTime;
      // Layer 1: noise body
      const n1 = noise(0.16, 2500, 1.2, 700, 0.9, 0.012);
      // Layer 2: bright snap
      const n2 = noise(0.07, 4200, 1.8,  0,   0.6, 0.006, true);
      // Layer 3: short click
      const osc = AC.createOscillator(); osc.type='triangle'; osc.frequency.setValueAtTime(3200, now);
      const g3  = AC.createGain(); g3.gain.setValueAtTime(0.001, now);
      g3.gain.exponentialRampToValueAtTime(0.2, now + 0.003);
      g3.gain.exponentialRampToValueAtTime(0.001, now + 0.05);
      osc.connect(g3); g3.connect(AC.destination);
      osc.start(now); osc.stop(now + 0.06);

      function noise(dur, bpFreq, bpQ, hpFreq, peak, attack, bandOnly=false){
        const frames = Math.floor(AC.sampleRate * dur);
        const buf = AC.createBuffer(1, frames, AC.sampleRate);
        const data = buf.getChannelData(0);
        for (let i=0;i<frames;i++){ let v=(Math.random()*2-1)*1.25; data[i]=Math.max(-1,Math.min(1,v)); }
        const src = AC.createBufferSource(); src.buffer=buf;
        const bp = AC.createBiquadFilter(); bp.type='bandpass'; bp.frequency.value=bpFreq; bp.Q.value=bpQ;
        const hp = AC.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=hpFreq||600;
        const g  = AC.createGain(); const t=AC.currentTime;
        g.gain.setValueAtTime(0.001,t); g.gain.exponentialRampToValueAtTime(peak,t+(attack||0.01));
        g.gain.exponentialRampToValueAtTime(0.001, t+dur);
        src.connect(bp); (bandOnly?bp:bp).connect(hp); hp.connect(g); g.connect(AC.destination);
        src.start(t); src.stop(t+dur+0.02);
        return src;
      }
    }
    document.addEventListener('pointerdown', ensureAudio, { once: true });

    // --- Confetti mini-Pringles ---
    const prefersReduced = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
    const dpr = Math.max(1, window.devicePixelRatio || 1);
    const fx = els.fx;
    const ctx = fx.getContext('2d');
    let particles = [];
    let rafId = 0;
    let sprite = null;

    function resizeCanvas(){
      const r = els.app.getBoundingClientRect();
      fx.width = Math.floor(r.width * dpr);
      fx.height = Math.floor(r.height * dpr);
      fx.style.width = r.width + 'px';
      fx.style.height = r.height + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener('resize', resizeCanvas);

    function loadSprite(){
      return new Promise((ok,err)=>{
        const im = new Image(); im.onload = ()=>ok(im); im.onerror = err; im.src = './pringle.png';
      });
    }

    function spawnConfettiFromChip(count=100){
      if (prefersReduced) return; // honor accessibility
      const rApp = els.app.getBoundingClientRect();
      const rChip = els.chipImg.getBoundingClientRect();
      // Start at center of displayed chip
      const origin = {
        x: rChip.left - rApp.left + rChip.width/2,
        y: rChip.top  - rApp.top  + rChip.height/2
      };
      const baseSize = Math.max(8, rChip.width / 20); // ~1/20 main chip size
      const N = Math.min(160, count);
      for (let i=0;i<N;i++){
        const ang = Math.random() * Math.PI * 2;
        const speed = 3 + Math.random()*4;         // px/frame at 60fps-ish
        const vx = Math.cos(ang) * speed;
        const vy = Math.sin(ang) * speed - (2 + Math.random()*1.5); // initial upward push
        particles.push({
          x: origin.x, y: origin.y,
          vx, vy,
          g: 0.12 + Math.random()*0.06,           // gravity
          life: 0, ttl: 900 + Math.random()*300,  // ms
          size: baseSize * (0.8 + Math.random()*0.6),
          rot: Math.random() * Math.PI*2,
          vr: (-0.2 + Math.random()*0.4),         // rotation speed
          alpha: 1
        });
      }
      if (!rafId) loop(performance.now());
    }

    function loop(prevTime){
      rafId = requestAnimationFrame((t)=>loop(t));
      const dt = Math.min(32, (performance.now() - prevTime)); // ms cap
      ctx.clearRect(0,0,fx.width/dpr,fx.height/dpr);

      const gDT = dt / 16.6667; // normalize to 60fps units
      particles = particles.filter(p=>{
        p.life += dt;
        if (p.life > p.ttl) return false;
        p.vy += p.g * gDT;
        p.x += p.vx * gDT;
        p.y += p.vy * gDT;
        p.rot += p.vr * gDT;
        // fade out last 25% of life
        const remain = 1 - (p.life / p.ttl);
        p.alpha = remain < 0.25 ? remain/0.25 : 1;
        // cull if offscreen
        return p.x>-60 && p.x<fx.width/dpr+60 && p.y<fx.height/dpr+80;
      });

      if (sprite){
        ctx.globalCompositeOperation = 'lighter';
        for (const p of particles){
          ctx.save();
          ctx.globalAlpha = p.alpha;
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rot);
          const w = p.size, h = p.size * (sprite.height / sprite.width);
          ctx.drawImage(sprite, -w/2, -h/2, w, h);
          ctx.restore();
        }
        ctx.globalCompositeOperation = 'source-over';
      }

      if (particles.length === 0){
        cancelAnimationFrame(rafId);
        rafId = 0;
      }
    }

    // Interactions
    $('#chipBtn').addEventListener('click', async () => {
      const prev = count;
      count++;
      if (navigator.vibrate) navigator.vibrate(12);
      els.chipImg.classList.remove('pop'); void els.chipImg.offsetWidth; els.chipImg.classList.add('pop');
      ensureAudio(); playCrunch();
      update(); checkBadges(prev, count); save();

      // Confetti
      if (!sprite) sprite = await loadSprite();
      resizeCanvas();
      spawnConfettiFromChip(100);
    });

    $('#undoBtn').addEventListener('click', () => {
      const prev = count; count = Math.max(0, count - 1); update(); save();
    });
    $('#resetBtn').addEventListener('click', () => {
      if (!confirm('Reset today’s Pringles count to 0?')) return;
      count = 0; update(); save();
    });
    window.addEventListener('keydown', (e) => {
      if (e.code === 'Space' || e.code === 'Enter'){ e.preventDefault(); $('#chipBtn').click(); }
    });

    // --- Share: robust PNG layout that always fits ---
    $('#shareBtn').addEventListener('click', async () => {
      const d = new Date();
      const title = `Pringle 1, 2, 3 — ${d.toLocaleDateString()}`;
      const text = `Today I ate ${count} Pringle${count===1?'':'s'}.\nCalories: ${fmt(count*CAL_PER,1)} kcal (${fmt(count*CAL_PCT,2)}%)\nSodium: ${fmt(count*SOD_MG,1)} mg (${fmt(count*SOD_PCT,2)}%)`;
      const pngBlob = await buildShareCard(title);
      if (navigator.canShare && navigator.canShare({ files: [new File([pngBlob], 'pringles.png', {type:'image/png'})] })){
        await navigator.share({ title, text, files: [new File([pngBlob], 'pringles.png', {type:'image/png'})] }).catch(()=>{});
      } else if (navigator.share){
        await navigator.share({ title, text }).catch(()=>{});
        downloadBlob(pngBlob, 'pringle-summary.png');
      } else {
        downloadBlob(pngBlob, 'pringle-summary.png');
        try{ await navigator.clipboard.writeText(text); toast('Summary copied to clipboard.'); }catch{}
      }
    });

    async function buildShareCard(title){
      const w = 1200, h = 630, pad = 48;
      const c = document.createElement('canvas'); c.width = w; c.height = h;
      const ctx = c.getContext('2d');

      // background + panel
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,'#151518'); g.addColorStop(1,'#0b0b0c');
      ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
      const panelX = pad, panelY = pad, panelW = w - pad*2, panelH = h - pad*2;
      ctx.fillStyle = '#0e0f12';
      roundRect(ctx, panelX, panelY, panelW, panelH, 28); ctx.fill();
      ctx.strokeStyle = '#23242c'; ctx.lineWidth = 2; ctx.stroke();

      // title
      ctx.fillStyle = '#fafafa';
      ctx.font = '700 64px system-ui, Segoe UI, Roboto';
      const titleY = panelY + 72;
      ctx.fillText(title, panelX + 24, titleY);

      // space budgeting
      const gap = 26;
      const statsLines = 3;
      const statsBlockH = 42 * statsLines + 6;
      const chipAreaTop = titleY + gap;
      const chipAreaBottom = panelY + panelH - gap - statsBlockH - 10;
      const chipAreaH = Math.max(120, chipAreaBottom - chipAreaTop);
      const chipAreaW = panelW - 48;

      // chip
      const chip = await loadImage('./pringle.png');
      const scale = Math.min(chipAreaW / chip.width, chipAreaH / chip.height, 1.0);
      const chipW = Math.floor(chip.width * scale);
      const chipH = Math.floor(chip.height * scale);
      const chipX = panelX + Math.floor((panelW - chipW)/2);
      const chipY = chipAreaTop + Math.floor((chipAreaH - chipH)/2);
      ctx.drawImage(chip, chipX, chipY, chipW, chipH);

      // stats
      const sX = panelX + 24;
      let sY = chipAreaBottom + 44;
      ctx.fillStyle = '#fafafa';
      ctx.font = '600 40px system-ui, Segoe UI, Roboto';
      ctx.fillText(`Pringles: ${count}`, sX, sY);

      ctx.fillStyle = '#ffd991';
      ctx.font = '600 34px system-ui, Segoe UI, Roboto';
      sY += 46;
      ctx.fillText(`Calories: ${fmt(count*CAL_PER,1)} kcal  (${fmt(count*CAL_PCT,2)}%)`, sX, sY);
      sY += 46;
      ctx.fillText(`Sodium: ${fmt(count*SOD_MG,1)} mg  (${fmt(count*SOD_PCT,2)}%)`, sX, sY);

      return await new Promise(res => c.toBlob(res, 'image/png'));
    }

    function roundRect(ctx, x,y,w,h,r){ctx.beginPath();ctx.moveTo(x+r,y);ctx.arcTo(x+w,y,x+w,y+h,r);ctx.arcTo(x+w,y+h,x,y+h,r);ctx.arcTo(x,y+h,x,y,r);ctx.arcTo(x,y,x+w,y,r);ctx.closePath();}
    function loadImage(src){ return new Promise((ok,err)=>{ const im=new Image(); im.onload=()=>ok(im); im.onerror=err; im.src=src; }); }
    function downloadBlob(blob, filename){
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = filename; a.click();
      setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
    }

    // Init
    ensureToday(); update(); resizeCanvas();

    // ---- Manifest (icons derived from pringle.png) ----
    async function genIconDataURL(src, size){
      const img = await loadImage(src);
      const c = document.createElement('canvas'); c.width = c.height = size;
      const ctx = c.getContext('2d');
      ctx.fillStyle = '#0b0b0c'; ctx.fillRect(0,0,size,size);
      const scale = Math.min(size / img.width, size / img.height);
      const w2 = Math.round(img.width * scale);
      const h2 = Math.round(img.height * scale);
      const x = Math.round((size - w2)/2);
      const y = Math.round((size - h2)/2);
      ctx.imageSmoothingQuality = 'high';
      ctx.drawImage(img, x, y, w2, h2);
